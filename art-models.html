<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">PDF Selector</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load pdf.js library for rendering PDFs to canvas/images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <!-- Use Inter font and custom styles for modal and body -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the modal to ensure proper hiding/showing */
        #modal {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
        #modal.active {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }
        /* Style for buttons/links */
        .pdf-link {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .pdf-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(129, 140, 248, 0.5), 0 4px 6px -2px rgba(129, 140, 248, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- The "Back to List" button is now FIXED to the bottom left corner -->
    <button id="back-button" class="hidden fixed bottom-4 left-4 sm:bottom-8 sm:left-8 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-2xl z-50" onclick="window.location.search = '';">
        &larr; Back to List
    </button>

    <!-- Header (Always visible) -->
    <header class="w-full max-w-7xl mb-6">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white text-center">
            <span class="text-indigo-400">PDF Gallery</span> Navigator
        </h1>
        <!-- Removed button from here -->
        <p id="current-pdf-display" class="text-gray-400 text-center mt-2"></p>
    </header>

    <!-- MAIN CONTENT CONTAINER -->
    <main class="w-full max-w-7xl flex-grow bg-gray-800 rounded-xl shadow-2xl p-4 sm:p-8">

        <!-- HOME VIEW: PDF LIST -->
        <div id="home-container" class="hidden">
            <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">Available PDF Documents</h2>
            
            <div id="manifest-loading" class="text-white text-center text-xl p-8 rounded-lg bg-gray-700">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Fetching PDF list...
            </div>

            <div id="no-pdfs-message" class="hidden p-6 bg-yellow-900 rounded-lg text-yellow-300">
                <p class="font-bold mb-2">No PDFs Found.</p>
                <p>Ensure that a file named <code class="bg-yellow-800 text-sm p-1 rounded">pdf/art-models/manifest.json</code> exists and is correctly structured.</p>
            </div>

            <div id="pdf-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- PDF list buttons will be injected here -->
            </div>
        </div>

        <!-- VIEWER VIEW: THUMBNAIL GALLERY -->
        <div id="viewer-container" class="hidden">
            <div id="loading-message" class="text-white text-center text-xl p-8 rounded-lg bg-gray-700">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Fetching PDF file...
            </div>
            
            <!-- Thumbnail Container: 2-column grid -->
            <div id="thumbnail-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hidden">
                <!-- Thumbnails will be injected here by JavaScript -->
            </div>

            <div id="error-message" class="hidden text-red-400 text-center p-8 bg-red-900 rounded-lg mt-4">
                <p class="font-bold mb-2">Error Loading PDF</p>
                <p id="detailed-error"></p>
                <p class="mt-4">Please ensure the file path is correct and the PDF is accessible.</p>
            </div>
        </div>
    </main>

    <!-- Full-screen Modal for Large Preview (Hidden by default) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50 transition-opacity duration-300">
        <div class="relative w-full h-full flex flex-col justify-center items-center p-4">
            <!-- Close Button -->
            <button id="close-modal" class="absolute top-4 right-4 text-white text-4xl font-bold p-2 rounded-full bg-gray-700 hover:bg-gray-500 transition duration-200 shadow-lg z-50">
                &times;
            </button>
            <!-- Large Image Preview (will be centered and screen width) -->
            <img id="large-preview-image" src="" alt="Full page preview" class="w-full max-w-screen-xl max-h-full object-contain cursor-pointer rounded-lg shadow-xl" onclick="document.getElementById('modal').classList.remove('active');">
            <p id="modal-page-label" class="mt-4 text-white text-lg font-semibold"></p>
        </div>
    </div>

    <!-- JavaScript for Routing, PDF Rendering and Interaction -->
    <script>
        // --- Configuration and Elements ---
        const BASE_PDF_PATH = 'pdf/art-models/';
        const MANIFEST_URL = BASE_PDF_PATH + 'manifest.json';
        
        const thumbnailGrid = document.getElementById('thumbnail-grid');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const detailedError = document.getElementById('detailed-error');
        const modal = document.getElementById('modal');
        const largePreviewImage = document.getElementById('large-preview-image');
        const closeModalButton = document.getElementById('close-modal');
        const modalPageLabel = document.getElementById('modal-page-label');
        const homeContainer = document.getElementById('home-container');
        const viewerContainer = document.getElementById('viewer-container');
        const pdfListContainer = document.getElementById('pdf-list');
        const backButton = document.getElementById('back-button');
        const currentPdfDisplay = document.getElementById('current-pdf-display');
        const pageTitle = document.getElementById('page-title');
        const manifestLoading = document.getElementById('manifest-loading');
        const noPdfsMessage = document.getElementById('no-pdfs-message');

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- Utility Functions ---

        /**
         * Parses the URL search string for a given parameter name.
         */
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        /**
         * Helper function to handle async fetching with exponential backoff and retries.
         */
        async function fetchWithRetry(url, attempts = 3) {
            for (let i = 0; i < attempts; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} (${response.statusText})`);
                    }
                    return response;
                } catch (error) {
                    if (i === attempts - 1) throw error;
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }
        
        /**
         * Fetches the list of PDF files from the manifest.json.
         */
        async function fetchPdfList() {
            try {
                // Try to fetch the manifest file
                const response = await fetchWithRetry(MANIFEST_URL);
                const fileNames = await response.json();

                // Validate the response format
                if (Array.isArray(fileNames) && fileNames.every(name => typeof name === 'string' && name.endsWith('.pdf'))) {
                    return fileNames;
                } else {
                    console.error('Manifest file is present but invalid. Expected a JSON array of strings ending in .pdf');
                    return [];
                }
            } catch (error) {
                // This will likely catch the 404 error if manifest.json is missing
                console.warn('Could not fetch PDF manifest. Assuming no PDFs are available or manifest is missing.', error.message);
                return [];
            }
        }

        /**
         * Function to render a single PDF page to a canvas and return the image data URL.
         */
        async function renderPage(pdf, pageNumber, scale) {
            const page = await pdf.getPage(pageNumber);
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // --- View Handlers ---

        /**
         * Renders the Home View (list of PDFs).
         */
        async function renderHome() {
            homeContainer.classList.remove('hidden');
            viewerContainer.classList.add('hidden');
            backButton.classList.add('hidden');
            pageTitle.textContent = "PDF Selector";
            currentPdfDisplay.textContent = 'Fetching available PDF documents...';

            manifestLoading.classList.remove('hidden');
            pdfListContainer.classList.add('hidden');
            noPdfsMessage.classList.add('hidden');
            pdfListContainer.innerHTML = ''; // Clear previous list

            const pdfFiles = await fetchPdfList();

            manifestLoading.classList.add('hidden');
            currentPdfDisplay.textContent = 'Select a document to view its thumbnail gallery.';

            if (pdfFiles.length > 0) {
                pdfListContainer.classList.remove('hidden');
                pdfFiles.forEach(fileName => {
                    const link = document.createElement('a');
                    // Set the URL search parameter for routing
                    link.href = `?file=${encodeURIComponent(fileName)}`; 
                    link.className = 'pdf-link flex flex-col items-center p-4 bg-indigo-600 rounded-xl shadow-lg text-white font-semibold text-center border-b-4 border-indigo-700';
                    link.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mb-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.25 9L15 12.75l1.875 1.875M16.875 14.625v-4.5h2.25c.828 0 1.5.672 1.5 1.5v2.25c0 .828-.672 1.5-1.5 1.5h-2.25Z" />
                        </svg>
                        <span>${fileName}</span>
                    `;
                    pdfListContainer.appendChild(link);
                });
            } else {
                noPdfsMessage.classList.remove('hidden');
            }
        }

        /**
         * Renders the Viewer View (Thumbnail Gallery) for a specific PDF.
         */
        async function loadPDFAndRenderThumbnails(pdfPath, fileName) {
            homeContainer.classList.add('hidden');
            viewerContainer.classList.remove('hidden');
            backButton.classList.remove('hidden');
            pageTitle.textContent = fileName;
            currentPdfDisplay.innerHTML = `Loading pages from: <code class="bg-gray-800 text-sm p-1 rounded">${pdfPath}</code>`;
            
            thumbnailGrid.innerHTML = '';
            thumbnailGrid.classList.add('hidden');
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            try {
                // 1. Fetch the PDF file data as ArrayBuffer
                loadingMessage.innerHTML = 'Fetching PDF file...';
                const response = await fetchWithRetry(pdfPath);
                const arrayBuffer = await response.arrayBuffer();

                loadingMessage.innerHTML = 'PDF fetched. Rendering pages...';
                
                // 2. Load PDF document from ArrayBuffer data
                const pdfData = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdfData.numPages;

                loadingMessage.innerHTML = `Rendering ${numPages} pages... This may take a moment.`;
                thumbnailGrid.classList.remove('hidden');

                // 3. Iterate through all pages
                for (let i = 1; i <= numPages; i++) {
                    // Create container for thumbnail
                    const thumbnailWrapper = document.createElement('div');
                    thumbnailWrapper.className = 'rounded-xl overflow-hidden shadow-lg border-4 border-gray-700 transition-transform duration-200 hover:scale-[1.03] cursor-pointer relative group bg-gray-900';
                    
                    // Add loading placeholder text
                    const placeholder = document.createElement('div');
                    placeholder.className = 'w-full h-48 sm:h-64 flex items-center justify-center text-gray-500 text-sm p-4';
                    placeholder.textContent = `Page ${i} loading...`;
                    thumbnailWrapper.appendChild(placeholder);

                    thumbnailGrid.appendChild(thumbnailWrapper);

                    // 4. Render the page as a small thumbnail (scale 0.5) and large preview (scale 1.5)
                    const [thumbnailUrl, largePreviewUrl] = await Promise.all([
                        renderPage(pdfData, i, 0.5),
                        renderPage(pdfData, i, 1.5)
                    ]);

                    // 5. Replace placeholder with image element
                    const img = document.createElement('img');
                    img.src = thumbnailUrl;
                    img.alt = `Thumbnail of page ${i}`;
                    img.className = 'w-full h-auto block transition-opacity duration-300 opacity-0';
                    img.setAttribute('data-full-src', largePreviewUrl);
                    
                    // On image load, fade it in and set click handler
                    img.onload = () => {
                        img.classList.remove('opacity-0');
                        if (thumbnailWrapper.contains(placeholder)) {
                             thumbnailWrapper.removeChild(placeholder);
                        }
                        thumbnailWrapper.appendChild(img);
                    };

                    // Click handler to open modal
                    thumbnailWrapper.onclick = () => {
                        largePreviewImage.src = largePreviewUrl;
                        modalPageLabel.textContent = `Page ${i} of ${numPages} for ${fileName}`;
                        modal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    };

                    // Add page number overlay
                    const pageLabel = document.createElement('div');
                    pageLabel.className = 'absolute bottom-0 right-0 m-2 px-2 py-1 bg-indigo-600 text-white text-xs font-bold rounded-full opacity-90 transition-opacity duration-300 group-hover:opacity-100';
                    pageLabel.textContent = `P. ${i}`;
                    thumbnailWrapper.appendChild(pageLabel);
                }

            } catch (error) {
                console.error('Error loading or rendering PDF:', error);
                
                const pathError = error.message.includes("HTTP error! status") 
                    ? `Network error: ${error.message}. Check that the path "${pdfPath}" is correct and the file exists.`
                    : `Processing error: ${error.message}`;

                detailedError.textContent = pathError;
                errorMessage.classList.remove('hidden');

            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // --- Initial Routing & Execution ---
        
        window.onload = function() {
            // Modal Close Handlers (only attach once)
            closeModalButton.onclick = () => {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            };
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            };
            
            // Check for file parameter to determine view
            const requestedFileName = getUrlParameter('file');

            if (requestedFileName) {
                // Viewer Mode
                const pdfPath = `${BASE_PDF_PATH}${requestedFileName}`;
                loadPDFAndRenderThumbnails(pdfPath, requestedFileName);
            } else {
                // Home Mode (Default)
                renderHome();
            }
        };

    </script>
</body>
</html>

